-- lua/sqlit_float/init.lua
local M = {}

---@class SqlitFloatConfig
---@field cmd string[]|string  -- {"sqlit"} or "sqlit"
---@field width number         -- 0~1 (ratio)
---@field height number        -- 0~1 (ratio)
---@field border string        -- "rounded" | "single" | ...
---@field title string
---@field title_pos string     -- "center" | "left" | "right"
---@field winblend integer     -- 0~100
local default_config = {
  cmd = { "sqlit" },
  width = 0.9,
  height = 0.85,
  border = "rounded",
  title = " sqlit ",
  title_pos = "center",
  winblend = 0,
}

local state = {
  buf = nil,
  win = nil,
  job = nil,
  config = default_config,
}

local function is_valid_win(win)
  return win and vim.api.nvim_win_is_valid(win)
end

local function is_valid_buf(buf)
  return buf and vim.api.nvim_buf_is_valid(buf)
end

local function calc_win_config()
  local columns = vim.o.columns
  local lines = vim.o.lines

  -- 留一點空間避免貼邊、也避開 cmdline
  local w = math.floor(columns * state.config.width)
  local h = math.floor(lines * state.config.height)

  if w < 20 then
    w = 20
  end
  if h < 5 then
    h = 5
  end

  local row = math.floor((lines - h) / 2 - 1)
  local col = math.floor((columns - w) / 2)

  if row < 0 then
    row = 0
  end
  if col < 0 then
    col = 0
  end

  return {
    relative = "editor",
    width = w,
    height = h,
    row = row,
    col = col,
    style = "minimal",
    border = state.config.border,
    title = state.config.title,
    title_pos = state.config.title_pos,
  }
end

local function ensure_buf()
  if is_valid_buf(state.buf) then
    return
  end
  state.buf = vim.api.nvim_create_buf(false, true) -- listed=false, scratch=true
  -- vim.bo[state.buf].buftype = "terminal"
  vim.bo[state.buf].bufhidden = "wipe"
  vim.bo[state.buf].swapfile = false
end

local function open_window()
  ensure_buf()
  local win = vim.api.nvim_open_win(state.buf, true, calc_win_config())
  state.win = win

  -- 視覺與行為
  vim.wo[win].winblend = state.config.winblend
  vim.wo[win].number = false
  vim.wo[win].relativenumber = false
  vim.wo[win].signcolumn = "no"
  vim.wo[win].cursorline = false

  -- 常用：q / <Esc> 關閉
  vim.keymap.set("n", "q", function()
    M.close()
  end, { buffer = state.buf, nowait = true, silent = true })
  vim.keymap.set("t", "<Esc>", [[<C-\><C-n>]], { buffer = state.buf, silent = true })
  vim.keymap.set("t", "<C-q>", function()
    M.close()
  end, { buffer = state.buf, silent = true })

  return win
end

local function start_job()
  if state.job and state.job > 0 then
    return
  end

  local cmd = state.config.cmd
  local ok, job = pcall(vim.fn.termopen, cmd, {
    on_exit = function()
      -- TUI 結束時自動把視窗關掉（但 buffer 會 wipe）
      vim.schedule(function()
        state.job = nil
        if is_valid_win(state.win) then
          pcall(vim.api.nvim_win_close, state.win, true)
        end
        state.win = nil
        state.buf = nil
      end)
    end,
  })
  if ok then
    state.job = job
  else
    vim.notify("termopen failed: " .. tostring(job), vim.log.levels.ERROR)
  end
end

function M.open()
  if is_valid_win(state.win) then
    vim.api.nvim_set_current_win(state.win)
    return
  end
  open_window()
  start_job()
  vim.cmd("startinsert")
end

function M.close()
  if is_valid_win(state.win) then
    pcall(vim.api.nvim_win_close, state.win, true)
  end
  state.win = nil

  -- 不強殺 job（讓 sqlit 自己退出）；你也可以改成強殺：
  -- if state.job then pcall(vim.fn.jobstop, state.job) end
  -- state.job = nil

  if is_valid_buf(state.buf) then
    pcall(vim.api.nvim_buf_delete, state.buf, { force = true })
  end
  state.buf = nil
end

function M.toggle()
  if is_valid_win(state.win) then
    M.close()
  else
    M.open()
  end
end

---@param cfg SqlitFloatConfig|nil
function M.setup(cfg)
  state.config = vim.tbl_deep_extend("force", {}, default_config, cfg or {})

  -- 提供 :SqlitFloatToggle 指令
  vim.api.nvim_create_user_command("SqlitFloatToggle", function()
    M.toggle()
  end, {})

  -- 視窗尺寸變更時自動 resize
  vim.api.nvim_create_autocmd("VimResized", {
    callback = function()
      if is_valid_win(state.win) then
        vim.api.nvim_win_set_config(state.win, calc_win_config())
      end
    end,
  })
end

return M
