---
# Bitwarden role - CLI installation + Desktop app (for SSH agent)
# CLI: Installs @bitwarden/cli via npm, with mise fallback when npm is not in PATH.
# Desktop: Installs Bitwarden desktop app (snap/deb on Linux, Homebrew cask on macOS)
#          when bitwarden_install_desktop=true (passed via --extra-vars)

# =============================================================================
# CLI Installation
# =============================================================================

- name: Check if Bitwarden CLI is already installed
  when: ansible_facts["os_family"] in ["Darwin", "Debian"]
  ansible.builtin.command: which bw
  register: bitwarden_cli_check
  changed_when: false
  failed_when: false

- name: Check if npm is available for Bitwarden CLI install
  when:
    - ansible_facts["os_family"] in ["Darwin", "Debian"]
    - bitwarden_cli_check.rc != 0
  ansible.builtin.command: npm --version
  register: bitwarden_npm_check
  changed_when: false
  failed_when: false

- name: Check for user-installed mise (Bitwarden fallback)
  when:
    - ansible_facts["os_family"] in ["Darwin", "Debian"]
    - bitwarden_cli_check.rc != 0
    - bitwarden_npm_check.rc != 0
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/bin/mise"
  register: bitwarden_mise_user_bin

- name: Set Bitwarden mise binary path (user install)
  when:
    - ansible_facts["os_family"] in ["Darwin", "Debian"]
    - bitwarden_cli_check.rc != 0
    - bitwarden_npm_check.rc != 0
    - bitwarden_mise_user_bin.stat.exists | default(false)
  ansible.builtin.set_fact:
    bitwarden_mise_bin: "{{ ansible_facts['env']['HOME'] }}/.local/bin/mise"

- name: Check for system mise (Bitwarden fallback)
  when:
    - ansible_facts["os_family"] in ["Darwin", "Debian"]
    - bitwarden_cli_check.rc != 0
    - bitwarden_npm_check.rc != 0
    - bitwarden_mise_bin is not defined
  ansible.builtin.command: mise --version
  register: bitwarden_mise_system_check
  changed_when: false
  failed_when: false

- name: Set Bitwarden mise binary path (system install)
  when:
    - ansible_facts["os_family"] in ["Darwin", "Debian"]
    - bitwarden_cli_check.rc != 0
    - bitwarden_npm_check.rc != 0
    - bitwarden_mise_bin is not defined
    - bitwarden_mise_system_check.rc == 0
  ansible.builtin.set_fact:
    bitwarden_mise_bin: mise

- name: Fail when neither npm nor mise is available for Bitwarden install
  when:
    - ansible_facts["os_family"] in ["Darwin", "Debian"]
    - bitwarden_cli_check.rc != 0
    - bitwarden_npm_check.rc != 0
    - bitwarden_mise_bin is not defined
  ansible.builtin.fail:
    msg: >-
      installBitwarden=true requires npm or mise (with npm runtime) to install
      {{ bitwarden_cli_npm_package }}. Ensure Node.js is installed (e.g. via mise)
      and re-run ansible.

- name: Install Bitwarden CLI via npm
  when:
    - ansible_facts["os_family"] in ["Darwin", "Debian"]
    - bitwarden_cli_check.rc != 0
    - bitwarden_npm_check.rc == 0
  community.general.npm:
    name: "{{ bitwarden_cli_npm_package }}"
    global: true
    state: present
  register: bitwarden_npm_install
  until: bitwarden_npm_install is succeeded
  retries: 3
  delay: 5

- name: Install Bitwarden CLI via mise npm fallback
  when:
    - ansible_facts["os_family"] in ["Darwin", "Debian"]
    - bitwarden_cli_check.rc != 0
    - bitwarden_npm_check.rc != 0
    - bitwarden_mise_bin is defined
  ansible.builtin.shell: |
    {{ bitwarden_mise_bin }} exec -- npm install -g {{ bitwarden_cli_npm_package }}
  args:
    executable: /bin/bash
  register: bitwarden_mise_npm_install
  until: bitwarden_mise_npm_install is succeeded
  retries: 3
  delay: 5
  changed_when: true

# =============================================================================
# Desktop App Installation (for SSH agent support)
# Only runs when bitwarden_install_desktop=true (set via --extra-vars)
# =============================================================================

# --- macOS: Homebrew Cask ---

- name: Check if Bitwarden Desktop is installed (macOS)
  when:
    - bitwarden_install_desktop | bool
    - ansible_facts["os_family"] == "Darwin"
  ansible.builtin.stat:
    path: /Applications/Bitwarden.app
  register: bitwarden_desktop_macos

- name: Install Bitwarden Desktop via Homebrew Cask (macOS)
  when:
    - bitwarden_install_desktop | bool
    - ansible_facts["os_family"] == "Darwin"
    - not (bitwarden_desktop_macos.stat.exists | default(false))
  community.general.homebrew_cask:
    name: bitwarden
    state: present

# --- Linux: Snap (primary) with .deb fallback ---

- name: Check if Bitwarden Desktop is already installed (Linux)
  when:
    - bitwarden_install_desktop | bool
    - ansible_facts["os_family"] == "Debian"
  ansible.builtin.shell: command -v bitwarden || snap list bitwarden 2>/dev/null
  register: bitwarden_desktop_linux_check
  changed_when: false
  failed_when: false

- name: Check if snap is available (Bitwarden Desktop)
  when:
    - bitwarden_install_desktop | bool
    - ansible_facts["os_family"] == "Debian"
    - bitwarden_desktop_linux_check.rc != 0
  ansible.builtin.command: which snap
  register: bitwarden_snap_check
  changed_when: false
  failed_when: false

- name: Install Bitwarden Desktop via snap (Linux)
  when:
    - bitwarden_install_desktop | bool
    - ansible_facts["os_family"] == "Debian"
    - bitwarden_desktop_linux_check.rc != 0
    - bitwarden_snap_check.rc == 0
  become: true
  tags: [sudo]
  community.general.snap:
    name: bitwarden
    state: present

- name: Install Bitwarden Desktop via .deb fallback (Linux)
  when:
    - bitwarden_install_desktop | bool
    - ansible_facts["os_family"] == "Debian"
    - bitwarden_desktop_linux_check.rc != 0
    - bitwarden_snap_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Download Bitwarden Desktop .deb package
      ansible.builtin.get_url:
        url: "https://vault.bitwarden.com/download/?app=desktop&platform=linux&variant=deb"
        dest: /tmp/bitwarden-desktop.deb
        mode: '0644'
        timeout: 120

    - name: Install Bitwarden Desktop .deb package
      ansible.builtin.apt:
        deb: /tmp/bitwarden-desktop.deb

    - name: Clean up Bitwarden Desktop .deb
      ansible.builtin.file:
        path: /tmp/bitwarden-desktop.deb
        state: absent

- name: Remind user to enable SSH agent (Bitwarden Desktop)
  when:
    - bitwarden_install_desktop | bool
    - (((bitwarden_desktop_linux_check | default({})).rc | default(0)) != 0) or
      (bitwarden_desktop_macos is defined and not (bitwarden_desktop_macos.stat.exists | default(true)))
  ansible.builtin.debug:
    msg: >-
      Bitwarden Desktop installed. To use the SSH agent:
      1. Open Bitwarden Desktop and log in
      2. Go to Settings > Enable SSH agent
      3. Import your SSH keys into the vault
      4. Open a new terminal -- SSH_AUTH_SOCK will be auto-detected
