---
# LazyVim dependencies role

# macOS - all via Homebrew
- name: Install LazyVim dependencies (macOS)
  when: ansible_facts["os_family"] == "Darwin"
  community.general.homebrew:
    name:
      - fzf
      - lazygit
      - tree-sitter
      - node
    state: present

# Linux - find mise binary (installed by bootstrap)
- name: Check for user-installed mise
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/bin/mise"
  register: mise_user_bin

- name: Set mise binary path (user install)
  when:
    - ansible_facts["os_family"] == "Debian"
    - mise_user_bin.stat.exists | default(false)
  ansible.builtin.set_fact:
    mise_bin: "{{ ansible_facts['env']['HOME'] }}/.local/bin/mise"

- name: Set mise binary path (system install)
  when:
    - ansible_facts["os_family"] == "Debian"
    - mise_bin is not defined
  ansible.builtin.set_fact:
    mise_bin: /usr/bin/mise

# Install mise tools from ~/.config/mise/config.toml (node@lts)
- name: Install mise global tools (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command:
    cmd: "{{ mise_bin }} install --yes"
  register: mise_install
  changed_when: "'install' in mise_install.stderr or 'install' in mise_install.stdout"

# fzf - install via git for latest version (apt version is outdated and lacks --zsh flag)
- name: Check if fzf is installed via git
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.fzf"
  register: fzf_git_dir

- name: Clone fzf from GitHub
  when:
    - ansible_facts["os_family"] == "Debian"
    - not fzf_git_dir.stat.exists
  ansible.builtin.git:
    repo: https://github.com/junegunn/fzf.git
    dest: "{{ ansible_facts['env']['HOME'] }}/.fzf"
    depth: 1

- name: Install fzf (binary only, shell integration handled by zsh config)
  when:
    - ansible_facts["os_family"] == "Debian"
    - not fzf_git_dir.stat.exists
  ansible.builtin.command:
    cmd: "{{ ansible_facts['env']['HOME'] }}/.fzf/install --bin"
  changed_when: true

# lazygit
- name: Check if lazygit is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: lazygit --version
  register: lazygit_check
  changed_when: false
  failed_when: false

- name: Install lazygit via PPA (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - lazygit_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Add lazygit PPA
      ansible.builtin.apt_repository:
        repo: ppa:lazygit-team/release
        state: present
      ignore_errors: true
      register: lazygit_ppa

    - name: Install lazygit from apt
      ansible.builtin.apt:
        name: lazygit
        state: present
      ignore_errors: true
      register: lazygit_apt
      when: lazygit_ppa is succeeded

- name: Install lazygit from GitHub releases (fallback)
  when:
    - ansible_facts["os_family"] == "Debian"
    - lazygit_check.rc != 0
    - lazygit_apt is not defined or lazygit_apt is failed or lazygit_apt is skipped
  become: true
  tags: [sudo]
  block:
    - name: Get latest lazygit release
      ansible.builtin.uri:
        url: https://api.github.com/repos/jesseduffield/lazygit/releases/latest
        return_content: true
      register: lazygit_release

    - name: Download lazygit binary
      ansible.builtin.get_url:
        url: "https://github.com/jesseduffield/lazygit/releases/download/{{ lazygit_release.json.tag_name }}/lazygit_{{ lazygit_release.json.tag_name | regex_replace('^v', '') }}_Linux_{{ ansible_facts['architecture'] | replace('x86_64', 'x86_64') | replace('aarch64', 'arm64') }}.tar.gz"
        dest: /tmp/lazygit.tar.gz
        mode: '0644'

    - name: Extract lazygit
      ansible.builtin.unarchive:
        src: /tmp/lazygit.tar.gz
        dest: /usr/local/bin
        remote_src: true
        extra_opts:
          - lazygit

    - name: Clean up lazygit tarball
      ansible.builtin.file:
        path: /tmp/lazygit.tar.gz
        state: absent

# tree-sitter-cli
- name: Check if tree-sitter is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: tree-sitter --version
  register: treesitter_check
  changed_when: false
  failed_when: false

- name: Install tree-sitter-cli via mise npm (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - treesitter_check.rc != 0
  ansible.builtin.shell: |
    {{ mise_bin }} exec -- npm install -g tree-sitter-cli
  args:
    executable: /bin/bash
  register: treesitter_npm
  changed_when: "'added' in treesitter_npm.stdout or 'added' in treesitter_npm.stderr"
  ignore_errors: true

- name: Install tree-sitter-cli via cargo (fallback)
  when:
    - ansible_facts["os_family"] == "Debian"
    - treesitter_check.rc != 0
    - treesitter_npm is failed
  ansible.builtin.shell: |
    if command -v cargo >/dev/null 2>&1; then
      cargo install tree-sitter-cli
    else
      echo "Neither Node.js nor cargo available for tree-sitter-cli"
      echo "Install manually: cargo install tree-sitter-cli"
      exit 0
    fi
  args:
    executable: /bin/bash
  changed_when: true
  ignore_errors: true
