---
# LazyVim dependencies role

# macOS - all via Homebrew
- name: Install LazyVim dependencies (macOS)
  when: ansible_facts["os_family"] == "Darwin"
  community.general.homebrew:
    name:
      - fzf
      - lazygit
      - tree-sitter
      - node
    state: present

# Linux - mixed sources
- name: Install LazyVim dependencies from apt (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name:
      - fzf
      - nodejs
      - npm
    state: present

- name: Check if lazygit is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: lazygit --version
  register: lazygit_check
  changed_when: false
  failed_when: false

- name: Install lazygit via PPA (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - lazygit_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Add lazygit PPA
      ansible.builtin.apt_repository:
        repo: ppa:lazygit-team/release
        state: present
      ignore_errors: true
      register: lazygit_ppa

    - name: Install lazygit from apt
      ansible.builtin.apt:
        name: lazygit
        state: present
      ignore_errors: true
      register: lazygit_apt
      when: lazygit_ppa is succeeded

- name: Install lazygit from GitHub releases (fallback)
  when:
    - ansible_facts["os_family"] == "Debian"
    - lazygit_check.rc != 0
    - lazygit_apt is not defined or lazygit_apt is failed or lazygit_apt is skipped
  become: true
  tags: [sudo]
  block:
    - name: Get latest lazygit release
      ansible.builtin.uri:
        url: https://api.github.com/repos/jesseduffield/lazygit/releases/latest
        return_content: true
      register: lazygit_release

    - name: Download lazygit binary
      ansible.builtin.get_url:
        url: "https://github.com/jesseduffield/lazygit/releases/download/{{ lazygit_release.json.tag_name }}/lazygit_{{ lazygit_release.json.tag_name | regex_replace('^v', '') }}_Linux_{{ ansible_facts['architecture'] | replace('x86_64', 'x86_64') | replace('aarch64', 'arm64') }}.tar.gz"
        dest: /tmp/lazygit.tar.gz
        mode: '0644'

    - name: Extract lazygit
      ansible.builtin.unarchive:
        src: /tmp/lazygit.tar.gz
        dest: /usr/local/bin
        remote_src: true
        extra_opts:
          - lazygit

    - name: Clean up lazygit tarball
      ansible.builtin.file:
        path: /tmp/lazygit.tar.gz
        state: absent

- name: Install tree-sitter-cli via npm
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  community.general.npm:
    name: tree-sitter-cli
    global: true
    state: present
  ignore_errors: true
