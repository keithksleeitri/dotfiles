---
# Brew Bundle role - Install GUI applications from Brewfile
# macOS only - uses brew bundle to install casks and mas apps

# =============================================================================
# Prerequisites
# =============================================================================

- name: Check if running on macOS
  ansible.builtin.assert:
    that:
      - ansible_facts["os_family"] == "Darwin"
    fail_msg: "brew_bundle role is only supported on macOS"
    quiet: true

- name: Check if Homebrew is installed
  ansible.builtin.stat:
    path: /opt/homebrew/bin/brew
  register: homebrew_arm

- name: Check if Homebrew is installed (Intel)
  ansible.builtin.stat:
    path: /usr/local/bin/brew
  register: homebrew_intel

- name: Fail if Homebrew is not installed
  ansible.builtin.assert:
    that:
      - homebrew_arm.stat.exists or homebrew_intel.stat.exists
    fail_msg: "Homebrew is not installed. Run homebrew role first."
    quiet: true

# =============================================================================
# Install mas CLI (Mac App Store)
# =============================================================================

- name: Install mas (Mac App Store CLI)
  community.general.homebrew:
    name: mas
    state: present

# =============================================================================
# Check for Brewfile
# =============================================================================

- name: Check if Brewfile exists
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.Brewfile"
  register: brewfile_check

- name: Display Brewfile status
  ansible.builtin.debug:
    msg: "Brewfile found at ~/.Brewfile"
  when: brewfile_check.stat.exists

- name: Skip brew bundle if no Brewfile
  ansible.builtin.debug:
    msg: "No ~/.Brewfile found. Skipping brew bundle. Run 'chezmoi apply' to deploy Brewfile."
  when: not brewfile_check.stat.exists

# =============================================================================
# Run brew bundle
# =============================================================================

- name: Run brew bundle (install apps from Brewfile)
  when: brewfile_check.stat.exists
  ansible.builtin.shell: |
    # Determine brew path
    if [ -f /opt/homebrew/bin/brew ]; then
      eval "$(/opt/homebrew/bin/brew shellenv)"
    else
      eval "$(/usr/local/bin/brew shellenv)"
    fi

    # Run brew bundle with verbose output
    # --no-lock: don't create Brewfile.lock.json
    # --no-upgrade: don't upgrade already installed packages
    brew bundle --file="{{ ansible_facts.env.HOME }}/.Brewfile" --no-lock --no-upgrade --verbose
  args:
    executable: /bin/bash
  register: brew_bundle_result
  changed_when: "'Installing' in brew_bundle_result.stdout or 'Upgrading' in brew_bundle_result.stdout"
  # Don't fail if some casks fail (e.g., already installed via other means)
  ignore_errors: "{{ brew_bundle_ignore_errors | default(true) }}"

- name: Display brew bundle summary
  when:
    - brewfile_check.stat.exists
    - brew_bundle_result is defined
  ansible.builtin.debug:
    msg: |
      Brew bundle completed.
      {{ 'Some packages may have been skipped (already installed or unavailable).' if brew_bundle_result.rc != 0 else 'All packages installed successfully.' }}

# =============================================================================
# mas sign-in reminder
# =============================================================================

- name: Check mas sign-in status
  when: brewfile_check.stat.exists
  ansible.builtin.shell: mas account 2>/dev/null || echo "not signed in"
  args:
    executable: /bin/bash
  register: mas_account
  changed_when: false
  failed_when: false

- name: Remind about mas sign-in
  when:
    - brewfile_check.stat.exists
    - "'not signed in' in mas_account.stdout or mas_account.rc != 0"
  ansible.builtin.debug:
    msg: |
      NOTE: You are not signed in to the Mac App Store.
      To install mas apps, sign in via App Store.app or run: mas signin your@email.com
