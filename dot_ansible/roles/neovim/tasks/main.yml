---
# Neovim role - install Neovim with version check

- name: Check current Neovim version
  ansible.builtin.shell: nvim --version 2>/dev/null | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+'
  register: nvim_version_check
  changed_when: false
  failed_when: false

- name: Set Neovim version fact
  ansible.builtin.set_fact:
    nvim_current_version: "{{ nvim_version_check.stdout | default('0.0.0') }}"

- name: Display current Neovim version
  ansible.builtin.debug:
    msg: "Current Neovim version: {{ nvim_current_version }} (required: >= {{ neovim_min_version }})"

# macOS - use Homebrew
- name: Install Neovim (macOS)
  when: ansible_facts["os_family"] == "Darwin"
  community.general.homebrew:
    name: neovim
    state: latest

# Linux - try apt first, then snap
- name: Install Neovim from apt (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: neovim
    state: present
  register: apt_neovim

- name: Check Neovim version after apt install
  when: ansible_facts["os_family"] == "Debian" and apt_neovim is succeeded
  ansible.builtin.shell: nvim --version 2>/dev/null | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+'
  register: nvim_apt_version
  changed_when: false
  failed_when: false

- name: Check if snap is available
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: which snap
  register: snap_check
  changed_when: false
  failed_when: false

- name: Install Neovim from snap if apt version too old
  when:
    - ansible_facts["os_family"] == "Debian"
    - nvim_apt_version.stdout is defined
    - nvim_apt_version.stdout is version(neovim_min_version, '<')
    - snap_check.rc == 0
  become: true
  tags: [sudo]
  block:
    - name: Remove apt Neovim
      ansible.builtin.apt:
        name: neovim
        state: absent

    - name: Install Neovim from snap
      community.general.snap:
        name: nvim
        classic: true
        state: present

- name: Install Neovim from GitHub releases if snap unavailable
  when:
    - ansible_facts["os_family"] == "Debian"
    - nvim_apt_version.stdout is defined
    - nvim_apt_version.stdout is version(neovim_min_version, '<')
    - snap_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Remove apt Neovim (before GitHub install)
      ansible.builtin.apt:
        name: neovim
        state: absent

    - name: Get latest Neovim release
      ansible.builtin.uri:
        url: https://api.github.com/repos/neovim/neovim/releases/latest
        return_content: true
      register: nvim_release

    - name: Download Neovim tarball
      ansible.builtin.get_url:
        url: "https://github.com/neovim/neovim/releases/download/{{ nvim_release.json.tag_name }}/nvim-linux-{{ ansible_facts['architecture'] | replace('x86_64', 'x86_64') | replace('aarch64', 'arm64') }}.tar.gz"
        dest: /tmp/nvim.tar.gz
        mode: '0644'

    - name: Create /opt/nvim directory
      ansible.builtin.file:
        path: /opt/nvim
        state: directory
        mode: '0755'

    - name: Extract Neovim
      ansible.builtin.unarchive:
        src: /tmp/nvim.tar.gz
        dest: /opt/nvim
        remote_src: true
        extra_opts:
          - --strip-components=1

    - name: Create nvim symlink
      ansible.builtin.file:
        src: /opt/nvim/bin/nvim
        dest: /usr/local/bin/nvim
        state: link

    - name: Clean up Neovim tarball
      ansible.builtin.file:
        path: /tmp/nvim.tar.gz
        state: absent

    - name: Display installed Neovim version
      ansible.builtin.debug:
        msg: "Installed Neovim {{ nvim_release.json.tag_name }} from GitHub releases"
