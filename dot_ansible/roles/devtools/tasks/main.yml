---
# Developer CLI tools role
# Tools: bat, eza, git-delta, tldr, thefuck, zoxide, direnv, yazi, tmux, zellij, btop, htop

# =============================================================================
# macOS - all via Homebrew
# =============================================================================

- name: Install developer CLI tools (macOS)
  when: ansible_facts["os_family"] == "Darwin"
  community.general.homebrew:
    name:
      - bat
      - git-delta
      - eza
      - tlrc
      - thefuck
      - zoxide
      - direnv
      - yazi
      - tmux
      - zellij
      - btop
      - htop
    state: present

# =============================================================================
# Linux (Debian/Ubuntu)
# =============================================================================

# --- bat ---
- name: Install bat (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: bat
    state: present

- name: Create bat symlink on Debian/Ubuntu
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.file:
    src: /usr/bin/batcat
    dest: /usr/bin/bat
    state: link
  ignore_errors: true

# --- zoxide ---
- name: Check if zoxide is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: zoxide --version
  register: zoxide_check
  changed_when: false
  failed_when: false

- name: Install zoxide via official installer (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - zoxide_check.rc != 0
  ansible.builtin.shell: |
    curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
  args:
    creates: "{{ ansible_facts.env.HOME }}/.local/bin/zoxide"

# --- eza ---
- name: Check if eza is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: eza --version
  register: eza_check
  changed_when: false
  failed_when: false

- name: Install eza via official installer (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - eza_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Add eza GPG key
      ansible.builtin.shell: |
        mkdir -p /etc/apt/keyrings
        wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
      args:
        creates: /etc/apt/keyrings/gierens.gpg

    - name: Add eza repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main"
        state: present
        filename: gierens

    - name: Install eza from repository
      ansible.builtin.apt:
        name: eza
        state: present
        update_cache: true

# --- git-delta ---
- name: Check if delta is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: delta --version
  register: delta_check
  changed_when: false
  failed_when: false

- name: Install git-delta from GitHub releases (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - delta_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Get latest delta release
      ansible.builtin.uri:
        url: https://api.github.com/repos/dandavison/delta/releases/latest
        return_content: true
      register: delta_release

    - name: Download delta .deb package
      ansible.builtin.get_url:
        url: "https://github.com/dandavison/delta/releases/download/{{ delta_release.json.tag_name }}/git-delta_{{ delta_release.json.tag_name }}_{{ ansible_facts['architecture'] | replace('x86_64', 'amd64') | replace('aarch64', 'arm64') }}.deb"
        dest: /tmp/git-delta.deb
        mode: '0644'

    - name: Install delta .deb package
      ansible.builtin.apt:
        deb: /tmp/git-delta.deb

    - name: Clean up delta .deb
      ansible.builtin.file:
        path: /tmp/git-delta.deb
        state: absent

# --- tldr ---
- name: Check if tldr is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: tldr --version
  register: tldr_check
  changed_when: false
  failed_when: false

- name: Install tldr via npm (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - tldr_check.rc != 0
  become: true
  tags: [sudo]
  community.general.npm:
    name: tldr
    global: true
    state: present
  ignore_errors: true

# --- thefuck ---
- name: Check if thefuck is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: thefuck --version
  register: thefuck_check
  changed_when: false
  failed_when: false

- name: Install thefuck via pip (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - thefuck_check.rc != 0
  ansible.builtin.pip:
    name: thefuck
    state: present
    extra_args: --user
  ignore_errors: true

# --- direnv ---
- name: Install direnv (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: direnv
    state: present

# --- yazi ---
- name: Check if yazi is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: yazi --version
  register: yazi_check
  changed_when: false
  failed_when: false

- name: Install yazi from GitHub releases (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - yazi_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Get latest yazi release
      ansible.builtin.uri:
        url: https://api.github.com/repos/sxyazi/yazi/releases/latest
        return_content: true
      register: yazi_release

    - name: Download yazi binary
      ansible.builtin.get_url:
        url: "https://github.com/sxyazi/yazi/releases/download/{{ yazi_release.json.tag_name }}/yazi-{{ ansible_facts['architecture'] | replace('x86_64', 'x86_64') | replace('aarch64', 'aarch64') }}-unknown-linux-gnu.zip"
        dest: /tmp/yazi.zip
        mode: '0644'

    - name: Install unzip if not present
      ansible.builtin.apt:
        name: unzip
        state: present

    - name: Extract yazi
      ansible.builtin.unarchive:
        src: /tmp/yazi.zip
        dest: /tmp
        remote_src: true

    - name: Install yazi binary
      ansible.builtin.copy:
        src: "/tmp/yazi-{{ ansible_facts['architecture'] | replace('x86_64', 'x86_64') | replace('aarch64', 'aarch64') }}-unknown-linux-gnu/yazi"
        dest: /usr/local/bin/yazi
        mode: '0755'
        remote_src: true

    - name: Clean up yazi files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/yazi.zip
        - "/tmp/yazi-{{ ansible_facts['architecture'] | replace('x86_64', 'x86_64') | replace('aarch64', 'aarch64') }}-unknown-linux-gnu"

# --- tmux ---
- name: Install tmux (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: tmux
    state: present

# --- htop ---
- name: Install htop (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: htop
    state: present

# --- btop ---
- name: Install btop (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: btop
    state: present
  ignore_errors: true

# --- zellij ---
- name: Check if zellij is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: zellij --version
  register: zellij_check
  changed_when: false
  failed_when: false

- name: Install zellij from GitHub releases (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - zellij_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Get latest zellij release
      ansible.builtin.uri:
        url: https://api.github.com/repos/zellij-org/zellij/releases/latest
        return_content: true
      register: zellij_release

    - name: Download zellij binary
      ansible.builtin.get_url:
        url: "https://github.com/zellij-org/zellij/releases/download/{{ zellij_release.json.tag_name }}/zellij-{{ ansible_facts['architecture'] | replace('x86_64', 'x86_64') | replace('aarch64', 'aarch64') }}-unknown-linux-musl.tar.gz"
        dest: /tmp/zellij.tar.gz
        mode: '0644'

    - name: Extract zellij
      ansible.builtin.unarchive:
        src: /tmp/zellij.tar.gz
        dest: /usr/local/bin
        remote_src: true

    - name: Clean up zellij tarball
      ansible.builtin.file:
        path: /tmp/zellij.tar.gz
        state: absent

# =============================================================================
# TPM (Tmux Plugin Manager) - All platforms
# =============================================================================

- name: Check if TPM is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.tmux/plugins/tpm"
  register: tpm_check

- name: Install TPM (Tmux Plugin Manager)
  when: not tpm_check.stat.exists
  ansible.builtin.git:
    repo: https://github.com/tmux-plugins/tpm
    dest: "{{ ansible_facts.env.HOME }}/.tmux/plugins/tpm"
    depth: 1
  register: tpm_installed

- name: Install tmux plugins via TPM
  when: tpm_installed.changed | default(false)
  ansible.builtin.shell: |
    # Source config to set TMUX_PLUGIN_MANAGER_PATH (works with running server)
    tmux source-file {{ ansible_facts.env.HOME }}/.tmux.conf
    # Now install plugins
    {{ ansible_facts.env.HOME }}/.tmux/plugins/tpm/bin/install_plugins
  args:
    executable: /bin/bash
  changed_when: true
