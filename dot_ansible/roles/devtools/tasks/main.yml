---
# Developer CLI tools role
# Tools: bat, eza, git-delta, tldr, thefuck, zoxide

# =============================================================================
# macOS - all via Homebrew
# =============================================================================

- name: Install developer CLI tools (macOS)
  when: ansible_facts["os_family"] == "Darwin"
  community.general.homebrew:
    name:
      - bat
      - git-delta
      - eza
      - tlrc
      - thefuck
      - zoxide
    state: present

# =============================================================================
# Linux (Debian/Ubuntu)
# =============================================================================

# --- bat ---
- name: Install bat (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: bat
    state: present

- name: Create bat symlink on Debian/Ubuntu
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.file:
    src: /usr/bin/batcat
    dest: /usr/bin/bat
    state: link
  ignore_errors: true

# --- zoxide ---
- name: Check if zoxide is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: zoxide --version
  register: zoxide_check
  changed_when: false
  failed_when: false

- name: Install zoxide via official installer (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - zoxide_check.rc != 0
  ansible.builtin.shell: |
    curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
  args:
    creates: "{{ ansible_env.HOME }}/.local/bin/zoxide"

# --- eza ---
- name: Check if eza is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: eza --version
  register: eza_check
  changed_when: false
  failed_when: false

- name: Install eza via official installer (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - eza_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Add eza GPG key
      ansible.builtin.shell: |
        mkdir -p /etc/apt/keyrings
        wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
      args:
        creates: /etc/apt/keyrings/gierens.gpg

    - name: Add eza repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main"
        state: present
        filename: gierens

    - name: Install eza from repository
      ansible.builtin.apt:
        name: eza
        state: present
        update_cache: true

# --- git-delta ---
- name: Check if delta is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: delta --version
  register: delta_check
  changed_when: false
  failed_when: false

- name: Install git-delta from GitHub releases (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - delta_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Get latest delta release
      ansible.builtin.uri:
        url: https://api.github.com/repos/dandavison/delta/releases/latest
        return_content: true
      register: delta_release

    - name: Download delta .deb package
      ansible.builtin.get_url:
        url: "https://github.com/dandavison/delta/releases/download/{{ delta_release.json.tag_name }}/git-delta_{{ delta_release.json.tag_name }}_{{ ansible_facts['architecture'] | replace('x86_64', 'amd64') | replace('aarch64', 'arm64') }}.deb"
        dest: /tmp/git-delta.deb
        mode: '0644'

    - name: Install delta .deb package
      ansible.builtin.apt:
        deb: /tmp/git-delta.deb

    - name: Clean up delta .deb
      ansible.builtin.file:
        path: /tmp/git-delta.deb
        state: absent

# --- tldr ---
- name: Check if tldr is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: tldr --version
  register: tldr_check
  changed_when: false
  failed_when: false

- name: Install tldr via npm (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - tldr_check.rc != 0
  become: true
  tags: [sudo]
  community.general.npm:
    name: tldr
    global: true
    state: present
  ignore_errors: true

# --- thefuck ---
- name: Check if thefuck is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: thefuck --version
  register: thefuck_check
  changed_when: false
  failed_when: false

- name: Install thefuck via pip (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - thefuck_check.rc != 0
  ansible.builtin.pip:
    name: thefuck
    state: present
    extra_args: --user
  ignore_errors: true
