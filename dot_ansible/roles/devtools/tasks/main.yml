---
# Developer CLI tools role
# Tools: bat, eza, git-delta, tldr, thefuck, zoxide, direnv, yazi, tmux, zellij, btop, htop

# =============================================================================
# macOS - all via Homebrew
# =============================================================================

- name: Install developer CLI tools (macOS)
  when: ansible_facts["os_family"] == "Darwin"
  community.general.homebrew:
    name:
      - bat
      - git-delta
      - eza
      - tlrc
      - thefuck
      - zoxide
      - direnv
      - yazi
      - tmux
      - zellij
      - btop
      - htop
    state: present

# =============================================================================
# Linux (Debian/Ubuntu)
# =============================================================================

# --- bat ---
- name: Install bat (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: bat
    state: present

- name: Create bat symlink on Debian/Ubuntu
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.file:
    src: /usr/bin/batcat
    dest: /usr/bin/bat
    state: link
  ignore_errors: true

# --- bat (user-level fallback) ---
- name: Re-check if bat is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.shell: command -v bat
  register: bat_recheck
  changed_when: false
  failed_when: false

- name: Install bat from GitHub releases (user-level, no sudo)
  when:
    - ansible_facts["os_family"] == "Debian"
    - bat_recheck.rc != 0
  block:
    - name: Ensure ~/.local/bin exists (bat)
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
        state: directory
        mode: '0755'

    - name: Get latest bat release
      ansible.builtin.uri:
        url: https://api.github.com/repos/sharkdp/bat/releases/latest
        return_content: true
      register: bat_release

    - name: Download bat binary
      ansible.builtin.get_url:
        url: "https://github.com/sharkdp/bat/releases/download/{{ bat_release.json.tag_name }}/bat-{{ bat_release.json.tag_name }}-{{ ansible_facts['architecture'] }}-unknown-linux-musl.tar.gz"
        dest: /tmp/bat.tar.gz
        mode: '0644'

    - name: Extract bat
      ansible.builtin.unarchive:
        src: /tmp/bat.tar.gz
        dest: /tmp
        remote_src: true

    - name: Install bat to ~/.local/bin
      ansible.builtin.copy:
        src: "/tmp/bat-{{ bat_release.json.tag_name }}-{{ ansible_facts['architecture'] }}-unknown-linux-musl/bat"
        dest: "{{ ansible_facts['env']['HOME'] }}/.local/bin/bat"
        mode: '0755'
        remote_src: true

    - name: Clean up bat temp files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/bat.tar.gz
        - "/tmp/bat-{{ bat_release.json.tag_name }}-{{ ansible_facts['architecture'] }}-unknown-linux-musl"

# --- zoxide ---
- name: Check if zoxide is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: zoxide --version
  register: zoxide_check
  changed_when: false
  failed_when: false

- name: Install zoxide via official installer (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - zoxide_check.rc != 0
  ansible.builtin.shell: |
    curl -sSfL https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh
  args:
    creates: "{{ ansible_facts.env.HOME }}/.local/bin/zoxide"

# --- eza ---
- name: Check if eza is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: eza --version
  register: eza_check
  changed_when: false
  failed_when: false

- name: Install eza via official installer (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - eza_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Add eza GPG key
      ansible.builtin.shell: |
        mkdir -p /etc/apt/keyrings
        wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
      args:
        creates: /etc/apt/keyrings/gierens.gpg

    - name: Add eza repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main"
        state: present
        filename: gierens

    - name: Install eza from repository
      ansible.builtin.apt:
        name: eza
        state: present
        update_cache: true

# --- eza (user-level fallback) ---
- name: Re-check if eza is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.shell: command -v eza
  register: eza_recheck
  changed_when: false
  failed_when: false

- name: Install eza from GitHub releases (user-level, no sudo)
  when:
    - ansible_facts["os_family"] == "Debian"
    - eza_recheck.rc != 0
  block:
    - name: Ensure ~/.local/bin exists (eza)
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
        state: directory
        mode: '0755'

    - name: Get latest eza release
      ansible.builtin.uri:
        url: https://api.github.com/repos/eza-community/eza/releases/latest
        return_content: true
      register: eza_release

    - name: Download eza binary
      ansible.builtin.get_url:
        url: "https://github.com/eza-community/eza/releases/download/{{ eza_release.json.tag_name }}/eza_{{ ansible_facts['architecture'] }}-unknown-linux-gnu.tar.gz"
        dest: /tmp/eza.tar.gz
        mode: '0644'

    - name: Extract eza to ~/.local/bin
      ansible.builtin.unarchive:
        src: /tmp/eza.tar.gz
        dest: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
        remote_src: true

    - name: Clean up eza tarball
      ansible.builtin.file:
        path: /tmp/eza.tar.gz
        state: absent

# --- git-delta ---
- name: Check if delta is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: delta --version
  register: delta_check
  changed_when: false
  failed_when: false

- name: Install git-delta from GitHub releases (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - delta_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Get latest delta release
      ansible.builtin.uri:
        url: https://api.github.com/repos/dandavison/delta/releases/latest
        return_content: true
      register: delta_release

    - name: Download delta .deb package
      ansible.builtin.get_url:
        url: "https://github.com/dandavison/delta/releases/download/{{ delta_release.json.tag_name }}/git-delta_{{ delta_release.json.tag_name }}_{{ ansible_facts['architecture'] | replace('x86_64', 'amd64') | replace('aarch64', 'arm64') }}.deb"
        dest: /tmp/git-delta.deb
        mode: '0644'

    - name: Install delta .deb package
      ansible.builtin.apt:
        deb: /tmp/git-delta.deb

    - name: Clean up delta .deb
      ansible.builtin.file:
        path: /tmp/git-delta.deb
        state: absent

# --- git-delta (user-level fallback) ---
- name: Re-check if delta is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.shell: command -v delta
  register: delta_recheck
  changed_when: false
  failed_when: false

- name: Install git-delta from GitHub releases (user-level, no sudo)
  when:
    - ansible_facts["os_family"] == "Debian"
    - delta_recheck.rc != 0
  block:
    - name: Ensure ~/.local/bin exists (delta)
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
        state: directory
        mode: '0755'

    - name: Get latest delta release (user)
      ansible.builtin.uri:
        url: https://api.github.com/repos/dandavison/delta/releases/latest
        return_content: true
      register: delta_release_user

    - name: Download delta tarball (user)
      ansible.builtin.get_url:
        url: "https://github.com/dandavison/delta/releases/download/{{ delta_release_user.json.tag_name }}/delta-{{ delta_release_user.json.tag_name }}-{{ ansible_facts['architecture'] }}-unknown-linux-gnu.tar.gz"
        dest: /tmp/delta.tar.gz
        mode: '0644'

    - name: Extract delta (user)
      ansible.builtin.unarchive:
        src: /tmp/delta.tar.gz
        dest: /tmp
        remote_src: true

    - name: Install delta to ~/.local/bin
      ansible.builtin.copy:
        src: "/tmp/delta-{{ delta_release_user.json.tag_name }}-{{ ansible_facts['architecture'] }}-unknown-linux-gnu/delta"
        dest: "{{ ansible_facts['env']['HOME'] }}/.local/bin/delta"
        mode: '0755'
        remote_src: true

    - name: Clean up delta temp files (user)
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/delta.tar.gz
        - "/tmp/delta-{{ delta_release_user.json.tag_name }}-{{ ansible_facts['architecture'] }}-unknown-linux-gnu"

# --- tldr ---
- name: Check if tldr is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: tldr --version
  register: tldr_check
  changed_when: false
  failed_when: false

- name: Install tldr via npm (Debian/Ubuntu, system-level)
  when:
    - ansible_facts["os_family"] == "Debian"
    - tldr_check.rc != 0
  become: true
  tags: [sudo]
  community.general.npm:
    name: tldr
    global: true
    state: present
  ignore_errors: true

# --- tldr (user-level fallback) ---
- name: Re-check if tldr is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.shell: command -v tldr
  register: tldr_recheck
  changed_when: false
  failed_when: false

- name: Install tldr via mise npm (user-level, no sudo)
  when:
    - ansible_facts["os_family"] == "Debian"
    - tldr_recheck.rc != 0
  ansible.builtin.shell: |
    if [ -x "{{ ansible_facts['env']['HOME'] }}/.local/bin/mise" ]; then
      {{ ansible_facts['env']['HOME'] }}/.local/bin/mise exec -- npm install -g tldr
    elif command -v mise >/dev/null 2>&1; then
      mise exec -- npm install -g tldr
    else
      echo "mise not found, skipping tldr install" >&2
      exit 0
    fi
  args:
    executable: /bin/bash
  changed_when: true
  ignore_errors: true

# --- thefuck ---
# NOTE: thefuck is now installed via uv tool (python_uv_tools role)
# This avoids conda/virtualenv Python path conflicts

# --- direnv ---
- name: Install direnv (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: direnv
    state: present

- name: Check installed direnv version
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.shell: |
    if [ -x "{{ ansible_facts['env']['HOME'] }}/.local/bin/direnv" ]; then
      "{{ ansible_facts['env']['HOME'] }}/.local/bin/direnv" --version | sed 's/^v//'
    elif command -v direnv >/dev/null 2>&1; then
      direnv --version | sed 's/^v//'
    else
      echo "0.0.0"
    fi
  args:
    executable: /bin/bash
  register: direnv_version
  changed_when: false

- name: Set direnv release architecture
  when:
    - ansible_facts["os_family"] == "Debian"
    - direnv_version.stdout | trim is version('2.32.1', '<')
  ansible.builtin.set_fact:
    direnv_release_arch: >-
      {{
        'amd64' if ansible_facts['architecture'] in ['x86_64', 'amd64']
        else 'arm64' if ansible_facts['architecture'] in ['aarch64', 'arm64']
        else 'arm' if ansible_facts['architecture'] in ['armv7l', 'armv6l', 'arm']
        else ansible_facts['architecture']
      }}

- name: Install direnv from GitHub releases (user-level fallback, min v2.32.1)
  when:
    - ansible_facts["os_family"] == "Debian"
    - direnv_version.stdout | trim is version('2.32.1', '<')
  block:
    - name: Ensure ~/.local/bin exists (direnv)
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
        state: directory
        mode: '0755'

    - name: Get latest direnv release
      ansible.builtin.uri:
        url: https://api.github.com/repos/direnv/direnv/releases/latest
        return_content: true
      register: direnv_release

    - name: Download direnv binary (user)
      ansible.builtin.get_url:
        url: "https://github.com/direnv/direnv/releases/download/{{ direnv_release.json.tag_name }}/direnv.linux-{{ direnv_release_arch }}"
        dest: "{{ ansible_facts['env']['HOME'] }}/.local/bin/direnv"
        mode: '0755'

# --- yazi ---
- name: Check if yazi is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: yazi --version
  register: yazi_check
  changed_when: false
  failed_when: false

- name: Install yazi from GitHub releases (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - yazi_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Get latest yazi release
      ansible.builtin.uri:
        url: https://api.github.com/repos/sxyazi/yazi/releases/latest
        return_content: true
      register: yazi_release

    - name: Download yazi binary
      ansible.builtin.get_url:
        url: "https://github.com/sxyazi/yazi/releases/download/{{ yazi_release.json.tag_name }}/yazi-{{ ansible_facts['architecture'] }}-unknown-linux-gnu.zip"
        dest: /tmp/yazi.zip
        mode: '0644'
        force: true

    - name: Install unzip if not present
      ansible.builtin.apt:
        name: unzip
        state: present

    - name: Extract and install yazi
      ansible.builtin.shell: |
        cd /tmp
        rm -rf /tmp/yazi-{{ ansible_facts['architecture'] }}-unknown-linux-*
        unzip -o yazi.zip
        cp /tmp/yazi-{{ ansible_facts['architecture'] }}-unknown-linux-*/yazi /usr/local/bin/yazi
        chmod 755 /usr/local/bin/yazi
      args:
        executable: /bin/bash
      changed_when: true

    - name: Clean up yazi files
      ansible.builtin.shell: |
        rm -f /tmp/yazi.zip
        rm -rf /tmp/yazi-{{ ansible_facts['architecture'] }}-unknown-linux-*
      args:
        executable: /bin/bash
      changed_when: false

# --- yazi (user-level fallback) ---
- name: Re-check if yazi is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.shell: command -v yazi
  register: yazi_recheck
  changed_when: false
  failed_when: false

- name: Install yazi from GitHub releases (user-level, no sudo)
  when:
    - ansible_facts["os_family"] == "Debian"
    - yazi_recheck.rc != 0
  block:
    - name: Ensure ~/.local/bin exists (yazi)
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
        state: directory
        mode: '0755'

    - name: Get latest yazi release (user)
      ansible.builtin.uri:
        url: https://api.github.com/repos/sxyazi/yazi/releases/latest
        return_content: true
      register: yazi_release_user

    - name: Download yazi binary (user)
      ansible.builtin.get_url:
        url: "https://github.com/sxyazi/yazi/releases/download/{{ yazi_release_user.json.tag_name }}/yazi-{{ ansible_facts['architecture'] }}-unknown-linux-gnu.zip"
        dest: /tmp/yazi.zip
        mode: '0644'
        force: true

    - name: Extract and install yazi (user)
      ansible.builtin.shell: |
        cd /tmp
        rm -rf /tmp/yazi-{{ ansible_facts['architecture'] }}-unknown-linux-*
        python3 -m zipfile -e yazi.zip .
        cp /tmp/yazi-{{ ansible_facts['architecture'] }}-unknown-linux-*/yazi {{ ansible_facts['env']['HOME'] }}/.local/bin/yazi
        chmod 755 {{ ansible_facts['env']['HOME'] }}/.local/bin/yazi
      args:
        executable: /bin/bash
      changed_when: true

    - name: Clean up yazi files (user)
      ansible.builtin.shell: |
        rm -f /tmp/yazi.zip
        rm -rf /tmp/yazi-{{ ansible_facts['architecture'] }}-unknown-linux-*
      args:
        executable: /bin/bash
      changed_when: false

# --- tmux ---
- name: Install tmux (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: tmux
    state: present

# --- htop ---
- name: Install htop (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: htop
    state: present

# --- btop ---
- name: Install btop (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: btop
    state: present
  ignore_errors: true

# --- btop (user-level fallback) ---
- name: Re-check if btop is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.shell: command -v btop
  register: btop_recheck
  changed_when: false
  failed_when: false

- name: Install btop from GitHub releases (user-level, no sudo)
  when:
    - ansible_facts["os_family"] == "Debian"
    - btop_recheck.rc != 0
  block:
    - name: Ensure ~/.local/bin exists (btop)
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
        state: directory
        mode: '0755'

    - name: Get latest btop release
      ansible.builtin.uri:
        url: https://api.github.com/repos/aristocratos/btop/releases/latest
        return_content: true
      register: btop_release

    - name: Download btop binary
      ansible.builtin.get_url:
        url: "https://github.com/aristocratos/btop/releases/download/{{ btop_release.json.tag_name }}/btop-{{ ansible_facts['architecture'] }}-linux-musl.tbz"
        dest: /tmp/btop.tbz
        mode: '0644'

    - name: Create btop temp directory
      ansible.builtin.file:
        path: /tmp/btop-extract
        state: directory
        mode: '0755'

    - name: Extract btop
      ansible.builtin.shell: |
        cd /tmp/btop-extract && tar xjf /tmp/btop.tbz
      args:
        executable: /bin/bash
      changed_when: true

    - name: Install btop to ~/.local/bin
      ansible.builtin.copy:
        src: /tmp/btop-extract/btop/bin/btop
        dest: "{{ ansible_facts['env']['HOME'] }}/.local/bin/btop"
        mode: '0755'
        remote_src: true

    - name: Clean up btop temp files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/btop.tbz
        - /tmp/btop-extract

# --- zellij ---
- name: Check if zellij is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: zellij --version
  register: zellij_check
  changed_when: false
  failed_when: false

- name: Install zellij from GitHub releases (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - zellij_check.rc != 0
  become: true
  tags: [sudo]
  block:
    - name: Get latest zellij release
      ansible.builtin.uri:
        url: https://api.github.com/repos/zellij-org/zellij/releases/latest
        return_content: true
      register: zellij_release

    - name: Download zellij binary
      ansible.builtin.get_url:
        url: "https://github.com/zellij-org/zellij/releases/download/{{ zellij_release.json.tag_name }}/zellij-{{ ansible_facts['architecture'] | replace('x86_64', 'x86_64') | replace('aarch64', 'aarch64') }}-unknown-linux-musl.tar.gz"
        dest: /tmp/zellij.tar.gz
        mode: '0644'

    - name: Extract zellij
      ansible.builtin.unarchive:
        src: /tmp/zellij.tar.gz
        dest: /usr/local/bin
        remote_src: true

    - name: Clean up zellij tarball
      ansible.builtin.file:
        path: /tmp/zellij.tar.gz
        state: absent

# --- zellij (user-level fallback) ---
- name: Re-check if zellij is installed
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.shell: command -v zellij
  register: zellij_recheck
  changed_when: false
  failed_when: false

- name: Install zellij from GitHub releases (user-level, no sudo)
  when:
    - ansible_facts["os_family"] == "Debian"
    - zellij_recheck.rc != 0
  block:
    - name: Ensure ~/.local/bin exists (zellij)
      ansible.builtin.file:
        path: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
        state: directory
        mode: '0755'

    - name: Get latest zellij release (user)
      ansible.builtin.uri:
        url: https://api.github.com/repos/zellij-org/zellij/releases/latest
        return_content: true
      register: zellij_release_user

    - name: Download zellij binary (user)
      ansible.builtin.get_url:
        url: "https://github.com/zellij-org/zellij/releases/download/{{ zellij_release_user.json.tag_name }}/zellij-{{ ansible_facts['architecture'] }}-unknown-linux-musl.tar.gz"
        dest: /tmp/zellij.tar.gz
        mode: '0644'

    - name: Extract zellij to ~/.local/bin (user)
      ansible.builtin.unarchive:
        src: /tmp/zellij.tar.gz
        dest: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
        remote_src: true

    - name: Clean up zellij tarball (user)
      ansible.builtin.file:
        path: /tmp/zellij.tar.gz
        state: absent

# =============================================================================
# TPM (Tmux Plugin Manager) - All platforms
# =============================================================================

- name: Check if TPM is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.tmux/plugins/tpm"
  register: tpm_check

- name: Install TPM (Tmux Plugin Manager)
  when: not tpm_check.stat.exists
  ansible.builtin.git:
    repo: https://github.com/tmux-plugins/tpm
    dest: "{{ ansible_facts.env.HOME }}/.tmux/plugins/tpm"
    depth: 1
  register: tpm_installed

- name: Install tmux plugins via TPM
  when: tpm_installed.changed | default(false)
  ansible.builtin.shell: |
    # Source config to set TMUX_PLUGIN_MANAGER_PATH (works with running server)
    tmux source-file {{ ansible_facts.env.HOME }}/.tmux.conf
    # Now install plugins
    {{ ansible_facts.env.HOME }}/.tmux/plugins/tpm/bin/install_plugins
  args:
    executable: /bin/bash
  changed_when: true
