---
# Cargo CLI tools installation
# Rust is installed via mise

# =============================================================================
# Ensure Rust is installed via mise
# =============================================================================

- name: Check for user-installed mise
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/bin/mise"
  register: mise_user_install

- name: Set mise binary path
  ansible.builtin.set_fact:
    mise_bin: "{{ mise_user_install.stat.exists | ternary(ansible_facts['env']['HOME'] + '/.local/bin/mise', '/opt/homebrew/bin/mise' if ansible_facts['os_family'] == 'Darwin' else '/usr/local/bin/mise') }}"

- name: Install Rust via mise
  ansible.builtin.command: "{{ mise_bin }} install rust@latest --yes"
  args:
    creates: "{{ ansible_facts['env']['HOME'] }}/.local/share/mise/installs/rust"
  environment:
    PATH: "{{ ansible_facts['env']['HOME'] }}/.local/bin:/opt/homebrew/bin:/usr/local/bin:{{ ansible_facts['env']['PATH'] }}"

# =============================================================================
# Install cargo tools (all platforms)
# =============================================================================

- name: Install Cargo CLI tools via cargo install
  ansible.builtin.command: "{{ mise_bin }} exec -- cargo install {{ item.name }}"
  args:
    creates: "{{ ansible_facts['env']['HOME'] }}/.cargo/bin/{{ item.binary }}"
  loop: "{{ cargo_tools }}"
  loop_control:
    label: "{{ item.name }}"
  environment:
    PATH: "{{ ansible_facts['env']['HOME'] }}/.local/bin:{{ ansible_facts['env']['HOME'] }}/.cargo/bin:{{ ansible_facts['env']['PATH'] }}"

# =============================================================================
# Pueue - macOS (via Homebrew)
# =============================================================================

- name: Install pueue via Homebrew (macOS)
  when: ansible_facts["os_family"] == "Darwin"
  community.general.homebrew:
    name: pueue
    state: present

# =============================================================================
# Pueue - Linux (via cargo + systemd)
# =============================================================================

- name: Install pueue via cargo (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.command: "{{ mise_bin }} exec -- cargo install pueue --locked"
  args:
    creates: "{{ ansible_facts['env']['HOME'] }}/.cargo/bin/pueue"
  environment:
    PATH: "{{ ansible_facts['env']['HOME'] }}/.local/bin:{{ ansible_facts['env']['HOME'] }}/.cargo/bin:{{ ansible_facts['env']['PATH'] }}"

# =============================================================================
# Pueue version checks (warn by default, optional strict enforcement)
# =============================================================================

- name: Check installed pueue version
  when: ansible_facts["os_family"] in ["Darwin", "Debian"]
  ansible.builtin.shell: pueue --version 2>/dev/null | awk '{print $2}'
  args:
    executable: /bin/bash
  register: pueue_version_raw
  changed_when: false
  failed_when: false

- name: Check installed pueued version
  when: ansible_facts["os_family"] in ["Darwin", "Debian"]
  ansible.builtin.shell: pueued --version 2>/dev/null | awk '{print $2}'
  args:
    executable: /bin/bash
  register: pueued_version_raw
  changed_when: false
  failed_when: false

- name: Parse installed pueue versions
  when: ansible_facts["os_family"] in ["Darwin", "Debian"]
  ansible.builtin.set_fact:
    pueue_version_installed: "{{ (pueue_version_raw.stdout | trim | regex_search('[0-9]+\\.[0-9]+\\.[0-9]+')) | default('0.0.0', true) }}"
    pueued_version_installed: "{{ (pueued_version_raw.stdout | trim | regex_search('[0-9]+\\.[0-9]+\\.[0-9]+')) | default('0.0.0', true) }}"

- name: Display installed pueue versions
  when: ansible_facts["os_family"] in ["Darwin", "Debian"]
  ansible.builtin.debug:
    msg: "Installed pueue versions: pueue={{ pueue_version_installed }}, pueued={{ pueued_version_installed }} (required: >= {{ pueue_min_version }}, enforce={{ pueue_version_enforce | bool }})"

- name: Warn if pueue versions are below minimum (non-enforcing mode)
  when:
    - ansible_facts["os_family"] in ["Darwin", "Debian"]
    - not (pueue_version_enforce | bool)
    - pueue_version_installed is version(pueue_min_version, '<') or pueued_version_installed is version(pueue_min_version, '<')
  ansible.builtin.debug:
    msg: "WARNING: pueue={{ pueue_version_installed }}, pueued={{ pueued_version_installed }} are below required {{ pueue_min_version }}. Set pueue_version_enforce=true to fail on this condition."

- name: Enforce minimum pueue versions
  when:
    - ansible_facts["os_family"] in ["Darwin", "Debian"]
    - pueue_version_enforce | bool
  ansible.builtin.assert:
    that:
      - pueue_version_installed is version(pueue_min_version, '>=')
      - pueued_version_installed is version(pueue_min_version, '>=')
    fail_msg: "pueue version requirement failed: required >= {{ pueue_min_version }}, found pueue={{ pueue_version_installed }}, pueued={{ pueued_version_installed }}"
    success_msg: "pueue version requirement satisfied: pueue={{ pueue_version_installed }}, pueued={{ pueued_version_installed }}"

- name: Create systemd user directory
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/systemd/user"
    state: directory
    mode: '0755'

- name: Install pueued systemd user service
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.copy:
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/systemd/user/pueued.service"
    mode: '0644'
    content: |
      [Unit]
      Description=Pueue Daemon - CLI Process Queue
      Documentation=https://github.com/Nukesor/pueue

      [Service]
      ExecStart=%h/.cargo/bin/pueued --verbose
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=default.target

- name: Enable and start pueued service
  when: ansible_facts["os_family"] == "Debian"
  ansible.builtin.systemd:
    name: pueued
    scope: user
    enabled: true
    state: started
    daemon_reload: true
  ignore_errors: true  # May fail in containers without systemd
