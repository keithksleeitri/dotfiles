---
# Zsh role - install zsh, oh-my-zsh, and plugins

# Install zsh package
- name: Install zsh (macOS)
  when: ansible_facts["os_family"] == "Darwin"
  community.general.homebrew:
    name: zsh
    state: present

- name: Install zsh (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: zsh
    state: present

# Ensure locale is generated (prevents "cannot change locale" warnings)
- name: Ensure locales package is installed (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.apt:
    name: locales
    state: present

- name: Generate en_US.UTF-8 locale (Debian/Ubuntu)
  when: ansible_facts["os_family"] == "Debian"
  become: true
  tags: [sudo]
  ansible.builtin.command: locale-gen en_US.UTF-8
  register: locale_gen
  changed_when: "'Generation complete' in locale_gen.stdout"

# Set zsh as default shell
- name: Check current login shell
  ansible.builtin.shell: echo $SHELL
  args:
    executable: /bin/sh
  register: current_shell
  changed_when: false

- name: Set zsh as default shell (Debian/Ubuntu)
  when:
    - ansible_facts["os_family"] == "Debian"
    - "'/zsh' not in current_shell.stdout"
  become: true
  tags: [sudo]
  ansible.builtin.command: "chsh -s /usr/bin/zsh {{ ansible_facts['env']['USER'] }}"
  changed_when: true

- name: Set zsh as default shell (macOS)
  when:
    - ansible_facts["os_family"] == "Darwin"
    - "'/zsh' not in current_shell.stdout"
  ansible.builtin.command: "chsh -s /bin/zsh"
  changed_when: true

# Install oh-my-zsh (manual installation)
- name: Check if oh-my-zsh is installed
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.oh-my-zsh"
  register: ohmyzsh_check

- name: Clone oh-my-zsh
  when: not ohmyzsh_check.stat.exists
  ansible.builtin.git:
    repo: "{{ oh_my_zsh_repo }}"
    dest: "{{ ansible_facts['env']['HOME'] }}/.oh-my-zsh"
    depth: 1

# Clone zsh plugins to ZSH_CUSTOM/plugins
- name: Clone zsh plugins
  ansible.builtin.git:
    repo: "{{ item.repo }}"
    dest: "{{ ansible_facts['env']['HOME'] }}/.oh-my-zsh/custom/plugins/{{ item.name }}"
    depth: 1
    update: false
  loop: "{{ zsh_plugins }}"
