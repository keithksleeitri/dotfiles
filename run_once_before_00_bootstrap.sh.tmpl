#!/bin/bash
# Bootstrap script - installs Homebrew, uv, ansible, mise, and galaxy collections
# Runs BEFORE any ansible playbooks
# Profile: {{ .profile }}

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Ensure PATH includes local bin and Homebrew
export PATH="$HOME/.local/bin:$PATH"

# Add Homebrew to PATH if installed
{{ if eq .profile "macos" -}}
# macOS: Apple Silicon and Intel paths
if [[ -f /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -f /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi
{{ else -}}
# Linux: Linuxbrew paths
if [[ -d /home/linuxbrew/.linuxbrew ]]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
elif [[ -d "$HOME/.linuxbrew" ]]; then
    eval "$("$HOME/.linuxbrew/bin/brew" shellenv)"
fi
{{ end -}}

# =============================================================================
# 0. Homebrew Installation
# =============================================================================
# macOS: Always install Homebrew (required for ansible roles)
# Linux: Optional - only install if installBrewApps is enabled
# =============================================================================

{{ if eq .profile "macos" -}}
# macOS: Install Homebrew (required for package management)
if ! command -v brew &> /dev/null; then
    info "Installing Homebrew (macOS)..."
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    # Add to PATH for this session
    if [[ -f /opt/homebrew/bin/brew ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f /usr/local/bin/brew ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
    success "Homebrew installed successfully"
else
    info "Homebrew is already installed"
fi
{{ else -}}
# Linux: Linuxbrew is optional (only if installBrewApps is enabled)
# Most packages are managed by apt via Ansible
{{ if .installBrewApps -}}
if ! command -v brew &> /dev/null; then
    info "Installing Linuxbrew (optional, for brew bundle)..."
    # Install Linuxbrew dependencies first
    if command -v apt-get &> /dev/null; then
        sudo apt-get update
        sudo apt-get install -y build-essential procps curl file git
    fi
    # Install Linuxbrew
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    # Add to PATH for this session
    if [[ -d /home/linuxbrew/.linuxbrew ]]; then
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    elif [[ -d "$HOME/.linuxbrew" ]]; then
        eval "$("$HOME/.linuxbrew/bin/brew" shellenv)"
    fi
    success "Linuxbrew installed successfully"
else
    info "Linuxbrew is already installed"
fi
{{ else -}}
info "Linuxbrew installation skipped (installBrewApps=false)"
info "To install Linuxbrew later, run: chezmoi init --force and enable installBrewApps"
{{ end -}}
{{ end -}}
# 1. Install uv if missing
if ! command -v uv &> /dev/null; then
    info "Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    success "uv installed successfully"
else
    info "uv is already installed"
fi

# 2. Install mise if missing (runtime manager for Node.js, etc.)
if ! command -v mise &> /dev/null; then
    info "Installing mise..."
    # Try curl installer first (fast, no sudo)
    if curl -fsSL --connect-timeout 10 --max-time 60 https://mise.run | sh 2>/dev/null; then
        success "mise installed via curl"
    else
        # Fallback to apt for GFW environments
        warn "curl installer failed/timed out, trying apt..."
        if command -v apt-get &> /dev/null; then
            sudo apt-get update -y
            sudo apt-get install -y curl gpg
            sudo install -dm 755 /etc/apt/keyrings
            curl -fsSL https://mise.jdx.dev/gpg-key.pub | sudo tee /etc/apt/keyrings/mise-archive-keyring.pub >/dev/null
            echo "deb [signed-by=/etc/apt/keyrings/mise-archive-keyring.pub arch=amd64] https://mise.jdx.dev/deb stable main" | sudo tee /etc/apt/sources.list.d/mise.list
            sudo apt-get update -y
            sudo apt-get install -y mise
            success "mise installed via apt"
        else
            error "Could not install mise - please install manually"
        fi
    fi
else
    info "mise is already installed"
fi

# 3. Install ansible if missing
if ! command -v ansible-playbook &> /dev/null; then
    info "Installing ansible via uv..."
    uv tool install ansible-core
    success "ansible installed successfully"
else
    info "ansible is already installed"
fi

# 4. Install ansible-galaxy collections
info "Installing ansible-galaxy collections..."
ansible-galaxy collection install community.general --force-with-deps
success "ansible-galaxy collections installed"

# 5. Install mise global tools (Node.js) if mise config exists
MISE_BIN="${HOME}/.local/bin/mise"
[[ ! -x "$MISE_BIN" ]] && MISE_BIN="$(command -v mise 2>/dev/null || true)"
if [[ -x "$MISE_BIN" ]] && [[ -f "$HOME/.config/mise/config.toml" ]]; then
    info "Installing mise global tools..."
    "$MISE_BIN" install --yes
    success "mise tools installed"
fi

success "Bootstrap complete!"
