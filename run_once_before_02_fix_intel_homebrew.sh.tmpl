#!/bin/bash
# Fix Intel Mac Homebrew issues: directory permissions, Xcode CLT, stale links
# Only runs on macOS — separate from bootstrap so existing machines get the fix
# Profile: {{ .profile }}

{{ if ne .profile "macos" -}}
# Not macOS — nothing to do
exit 0
{{ else -}}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info()    { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
warn()    { echo -e "${YELLOW}[WARN]${NC} $1"; }
error()   { echo -e "${RED}[ERROR]${NC} $1"; }

# Add Homebrew to PATH
if [[ -f /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -f /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi

# =============================================================================
# 1. Fix Intel Homebrew directory permissions
# =============================================================================
# Only needed when Homebrew is installed at /usr/local (Intel Macs)
# After macOS upgrades, /usr/local permissions can revert to root ownership

if [[ -f /usr/local/bin/brew ]]; then
    info "Intel Homebrew detected — fixing /usr/local directory permissions..."
    for dir in Cellar Caskroom var/homebrew opt Homebrew lib include share Frameworks; do
        if [[ -d "/usr/local/$dir" ]]; then
            sudo chown -R "$(whoami)" "/usr/local/$dir" 2>/dev/null || warn "Could not fix permissions for /usr/local/$dir"
        fi
    done
    success "Intel Homebrew directory permissions fixed"
else
    info "Apple Silicon or no Homebrew — skipping Intel permission fix"
fi

# =============================================================================
# 2. Check and update Xcode Command Line Tools
# =============================================================================

if ! xcodebuild -version &>/dev/null; then
    warn "Xcode Command Line Tools are missing or outdated — attempting install..."

    # Create placeholder to trigger softwareupdate listing
    touch /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress

    CLT_PKG=$(softwareupdate -l 2>/dev/null \
        | grep -o '.*Command Line Tools.*' \
        | grep -v 'Finding' \
        | head -1 \
        | sed 's/^[* ]*//' \
        | sed 's/ *$//')

    if [[ -n "$CLT_PKG" ]]; then
        info "Installing: $CLT_PKG"
        sudo softwareupdate -i "$CLT_PKG" --verbose 2>/dev/null || true
        rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress
        if xcodebuild -version &>/dev/null; then
            success "Xcode Command Line Tools installed successfully"
        else
            warn "Auto-install may have failed. Please run: xcode-select --install"
        fi
    else
        rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress
        warn "Could not find CLT package via softwareupdate. Please run: xcode-select --install"
    fi
else
    info "Xcode Command Line Tools are up to date"
fi

# =============================================================================
# 3. Clean stale Homebrew links
# =============================================================================

if command -v brew &>/dev/null; then
    info "Cleaning stale Homebrew versions and links..."
    brew cleanup 2>/dev/null || warn "brew cleanup encountered issues (non-fatal)"
    success "Homebrew cleanup complete"
fi

{{ end -}}
